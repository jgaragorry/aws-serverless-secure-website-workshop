# üõ†Ô∏è Workshop: Despliegue y destrucci√≥n autom√°tica de sitio est√°tico seguro en AWS con Terraform y GitHub Actions

## üìã Descripci√≥n General

Este workshop gu√≠a a trav√©s del despliegue automatizado de un sitio web est√°tico seguro en AWS utilizando Terraform como Infraestructura como C√≥digo (IaC) y GitHub Actions para CI/CD. Incluye pr√°cticas de seguridad, monitoreo de costos (FinOps) y destrucci√≥n autom√°tica de recursos.

## üéØ Objetivos de Aprendizaje

- **Infraestructura como C√≥digo (IaC)**: Utilizar Terraform para definir y gestionar recursos AWS
- **CI/CD Automatizado**: Implementar pipelines con GitHub Actions
- **Seguridad**: Configurar pol√≠ticas IAM m√≠nimas y distribuci√≥n segura con CloudFront + S3
- **FinOps**: Monitorear costos con AWS Budgets
- **Resoluci√≥n de Problemas**: Diagnosticar y solucionar errores comunes en despliegues automatizados

## üèóÔ∏è Arquitectura de la Soluci√≥n

Usuario ‚Üí CloudFront (CDN) ‚Üí S3 Bucket (Sitio Est√°tico)  
‚Üì  
AWS Budgets (Alertas)

## ‚öôÔ∏è Prerrequisitos

- Cuenta AWS con permisos administrativos  
- Cuenta GitHub con acceso a GitHub Actions  
- Terraform instalado localmente (opcional, para testing)  
- AWS CLI configurado (opcional)

## üìò Reproducci√≥n completa del workshop desde cero

Para ver el procedimiento validado paso a paso, consulta [`steps.md`](./steps.md). Incluye desde la creaci√≥n del backend remoto hasta la destrucci√≥n de la infraestructura con GitHub Actions.


## üöÄ Despliegue Manual con Terraform

```bash
git clone https://github.com/jgaragorry/aws-serverless-secure-website-workshop
cd aws-serverless-secure-website-workshop/terraform
terraform init
terraform plan -var-file=terraform.tfvars
terraform apply -var-file=terraform.tfvars
terraform output -raw site_url
```

## üîê Configuraci√≥n Cr√≠tica de Credenciales AWS en GitHub Actions

‚ö†Ô∏è Esta configuraci√≥n es fundamental para el funcionamiento del despliegue automatizado. Si no se configura desde el inicio, Terraform no podr√° autenticarse con AWS, y todos los pasos del workflow fallar√°n.

### ‚úÖ Configuraci√≥n de Secrets en GitHub

Ir al repositorio ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions  
Crear los siguientes secretos:

| Nombre               | Valor (desde AWS IAM)                  |
|----------------------|----------------------------------------|
| AWS_ACCESS_KEY_ID    | Ejemplo: AKIAIOSFODNN7EXAMPLE          |
| AWS_SECRET_ACCESS_KEY| Ejemplo: wJalrXUtnFEMI/K7MDENG/...     |

üí° Aseg√∫rate de copiar los valores sin espacios extra, saltos de l√≠nea ni caracteres ocultos. Usa texto plano.

### üß† ¬øPor qu√© es importante?

Terraform usa estas variables para autenticarse con AWS. Si no est√°n definidas correctamente:

- `terraform plan` falla con `No valid credential sources found`  
- `terraform apply` no puede crear recursos  
- El workflow completo se detiene

## üöÄ Despliegue Autom√°tico con GitHub Actions

Archivo: `.github/workflows/deploy.yml`  
Este workflow se ejecuta autom√°ticamente al hacer push a la rama `main`:

1. Checkout del c√≥digo  
2. Configuraci√≥n de credenciales AWS usando GitHub Secrets  
3. `terraform init`  
4. `terraform plan -var-file=terraform.tfvars`  
5. `terraform apply`  
6. `terraform output -raw site_url`  
7. `curl -I $site_url` para verificar que el sitio est√© activo

### üß† Correcci√≥n Importante en Output

Para evitar errores de formato en `$GITHUB_OUTPUT`, se debe usar:

```yaml
- name: Obtener URL del sitio
  id: terraform_output
  run: |
    site_url=$(terraform -chdir=terraform output -raw site_url)
    echo "site_url=$site_url" >> $GITHUB_OUTPUT
```

### üß™ Validaci√≥n Esperada

- `terraform plan` y `apply` funcionan sin errores  
- Se extrae la URL del sitio con `terraform output`  
- El sitio se verifica con `curl -I` y retorna estado 200

## üßπ Destrucci√≥n Autom√°tica con GitHub Actions

Archivo: `.github/workflows/destroy.yml`  
Permite destruir toda la infraestructura manualmente desde la pesta√±a Actions de GitHub.

### Flujo del workflow:

1. `terraform init`  
2. `terraform destroy -auto-approve -var-file=terraform.tfvars`

### ‚úÖ Ejecuci√≥n Manual

Ir a GitHub ‚Üí pesta√±a Actions  
Seleccionar el workflow `Destroy Infrastructure`  
Click en `Run workflow`

## üîç Verificaci√≥n Manual Post-Destroy en AWS

Aunque `terraform destroy` reporta eliminaci√≥n completa, puede que queden recursos activos en consola AWS, especialmente distribuciones CloudFront.

### üß† Diagn√≥stico

Recursos creados o modificados fuera del control de Terraform no pueden ser destruidos autom√°ticamente.  
Ejemplo: distribuciones CloudFront activas que no est√°n en estado Terraform.

### ‚úÖ Soluci√≥n Aplicada

- Deshabilitar la distribuci√≥n manualmente en la consola AWS  
- Esperar la propagaci√≥n de cambios  
- Eliminar manualmente la distribuci√≥n residual

## üìã Checklist de Verificaci√≥n Post-Destroy

- S3 ‚Üí Buckets: no debe existir `secure-static-site-*`  
- CloudFront ‚Üí Distributions: ninguna activa  
- Billing ‚Üí Budgets: presupuesto eliminado  
- (Opcional) IAM ‚Üí Roles/Policies: sin residuos  
- (Opcional) CloudFormation / EC2 / Elastic IPs: sin recursos hu√©rfanos

## üõ†Ô∏è Estructura de Archivos Terraform

```text
terraform/
‚îú‚îÄ‚îÄ main.tf              # Recursos principales
‚îú‚îÄ‚îÄ variables.tf         # Variables definidas
‚îú‚îÄ‚îÄ terraform.tfvars     # Valores de variables
‚îú‚îÄ‚îÄ outputs.tf           # Outputs para GitHub Actions
‚îî‚îÄ‚îÄ providers.tf         # Configuraci√≥n de providers
```

## üõ†Ô∏è  Estructura del REPO

```
aws-serverless-secure-website-workshop/
‚îú‚îÄ‚îÄ src/                      # C√≥digo HTML del sitio
‚îÇ   ‚îî‚îÄ‚îÄ index.html            # P√°gina principal para S3
‚îú‚îÄ‚îÄ terraform/                # Infraestructura como c√≥digo
‚îÇ   ‚îú‚îÄ‚îÄ main.tf               # Recursos AWS y l√≥gica principal
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf          # Variables parametrizables
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf            # Resultados como URL de sitio
‚îÇ   ‚îî‚îÄ‚îÄ README-GUIA.md        # Gu√≠a t√©cnica detallada
‚îú‚îÄ‚îÄ .github/workflows/        # Pipelines CI/CD
‚îÇ   ‚îú‚îÄ‚îÄ deploy.yml            # Workflow de despliegue autom√°tico
‚îÇ   ‚îî‚îÄ‚îÄ destroy.yml           # Workflow de destrucci√≥n manual
‚îú‚îÄ‚îÄ scripts/                  # Automatizaci√≥n del backend remoto
‚îÇ   ‚îú‚îÄ‚îÄ create-backend.sh     # Script para crear el bucket remoto con versionado
‚îÇ   ‚îî‚îÄ‚îÄ delete-backend.sh     # Script para eliminar el bucket remoto con confirmaci√≥n
‚îú‚îÄ‚îÄ steps.md                  # Procedimiento completo validado desde cero
‚îú‚îÄ‚îÄ LICENSE                   # Licencia MIT
‚îú‚îÄ‚îÄ SECURITY.md               # Pol√≠tica de seguridad y cumplimiento
‚îú‚îÄ‚îÄ README.md                 # Este archivo principal
```


## üì¶ Recursos Principales Creados

- S3 Bucket: Almacenamiento est√°tico del sitio web  
- CloudFront Distribution: CDN para distribuci√≥n global y HTTPS  
- IAM Policies: Permisos m√≠nimos necesarios  
- AWS Budget: Monitoreo de costos y alertas

## üß™ Reproducci√≥n del Workshop para Validaci√≥n Completa

### Proceso de Validaci√≥n

1. Despliegue Inicial: Ejecutar workflow de deploy  
2. Verificaci√≥n Funcional: Confirmar que el sitio est√° accesible  
3. Destrucci√≥n: Ejecutar workflow de destroy  
4. Limpieza Manual: Verificar y eliminar recursos residuales  
5. Repetici√≥n: Confirmar que el proceso es reproducible

### Criterios de √âxito

- Todos los recursos se crean bajo control de Terraform  
- No quedan residuos manuales despu√©s de destroy  
- El modelo es reproducible y consistente  
- Las credenciales se gestionan de forma segura  
- Los costos se monitorean adecuadamente

## üîß Troubleshooting Com√∫n

- **Error**: `No valid credential sources found`  
  **Causa**: Secrets de AWS no configurados correctamente en GitHub  
  **Soluci√≥n**: Verificar formato y valores en GitHub Secrets

- **Error**: `CloudFront distribution still exists after destroy`  
  **Causa**: Distribuci√≥n no completamente deshabilitada  
  **Soluci√≥n**: Deshabilitar manualmente y esperar propagaci√≥n

- **Error**: `BucketNotEmpty` durante destroy  
  **Causa**: Objetos residuales en bucket S3  
  **Soluci√≥n**: Vaciar bucket manualmente antes de destroy
---

## üõ†Ô∏è Troubleshooting y validaci√≥n del flujo completo

Este workshop documenta no solo el despliegue exitoso de una infraestructura segura en AWS, sino tambi√©n los errores encontrados y c√≥mo se resolvieron de forma reproducible y did√°ctica.

Para revisar los problemas comunes, las correcciones aplicadas y c√≥mo validar que el flujo `deploy.yml ‚Üí destroy.yml` funciona correctamente con backend remoto, consulta el archivo:

üìÑ [`troubleshooting.md`](./troubleshooting.md)

Incluye:

- Migraci√≥n al backend remoto en S3
- Validaci√≥n de estado compartido entre workflows
- Ejecuci√≥n y verificaci√≥n de `destroy.yml`
- Checklist final para estudiantes

Este archivo forma parte integral del aprendizaje del workshop y debe ser revisado antes de avanzar a nuevas fases.

## ‚öôÔ∏è Automatizaci√≥n del backend remoto de Terraform

Este workshop utiliza un bucket S3 como backend remoto para almacenar el estado de Terraform (`terraform.tfstate`). Para facilitar su creaci√≥n y eliminaci√≥n controlada, se incluyen dos scripts Bash did√°cticos:

---

### üõ†Ô∏è `create-backend.sh` ‚Äî Crear el bucket remoto

Este script crea el bucket en la regi√≥n `us-east-1` y habilita el versionado.

```bash
#!/bin/bash

BUCKET_NAME="secure-static-site-central-seagull"
REGION="us-east-1"

echo "üöÄ Iniciando creaci√≥n del bucket remoto para Terraform backend..."
echo "üì¶ Bucket: $BUCKET_NAME"
echo "üåç Regi√≥n: $REGION"
echo

# Verificar si el bucket ya existe
if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
  echo "‚ö†Ô∏è El bucket '$BUCKET_NAME' ya existe. No se realizar√° ninguna acci√≥n."
  exit 0
fi

# Crear el bucket
echo "‚è≥ Creando bucket..."
aws s3api create-bucket \
  --bucket "$BUCKET_NAME" \
  --region "$REGION"

# Habilitar versionado
echo "‚è≥ Habilitando versionado..."
aws s3api put-bucket-versioning \
  --bucket "$BUCKET_NAME" \
  --versioning-configuration Status=Enabled

echo
echo "‚úÖ Bucket creado y versionado correctamente."
echo "üìç Usa este bucket en tu backend de Terraform para almacenar terraform.tfstate"
```

---

### üí£ `delete-backend.sh` ‚Äî Eliminar el bucket remoto (con confirmaci√≥n)

Este script elimina todos los objetos del bucket y luego lo borra, **solo si el usuario confirma expl√≠citamente**.

```bash
#!/bin/bash

BUCKET_NAME="secure-static-site-central-seagull"

echo "‚ö†Ô∏è Vas a eliminar el bucket remoto de Terraform backend:"
echo "üì¶ Bucket: $BUCKET_NAME"
echo
read -p "¬øEst√°s seguro de que deseas continuar? (escribe 's√≠' para confirmar): " CONFIRM

if [[ "$CONFIRM" != "s√≠" ]]; then
  echo "‚ùå Operaci√≥n cancelada por el usuario."
  exit 1
fi

echo "‚è≥ Eliminando objetos del bucket..."
aws s3 rm s3://"$BUCKET_NAME" --recursive

echo "‚è≥ Eliminando bucket..."
aws s3api delete-bucket \
  --bucket "$BUCKET_NAME"

echo
echo "‚úÖ Bucket eliminado completamente."
```

---

### üß† Consideraciones did√°cticas

- Estos scripts **no son gestionados por Terraform**, ya que el bucket del backend debe existir antes de ejecutar `terraform init`.
- El script de eliminaci√≥n requiere confirmaci√≥n expl√≠cita (`s√≠`) para evitar errores accidentales.
- Puedes incluir estos scripts en una carpeta `scripts/` y referenciarlos en tu gu√≠a como parte del flujo de preparaci√≥n y limpieza del entorno.

---

### üìÅ Ubicaci√≥n sugerida

```
aws-serverless-secure-website-workshop/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ create-backend.sh
‚îÇ   ‚îî‚îÄ‚îÄ delete-backend.sh
```

---

### üìö Uso en el flujo del workshop

- Ejecutar `create-backend.sh` antes de `terraform init`
- Ejecutar `delete-backend.sh` solo si deseas limpiar completamente el entorno

## ‚öôÔ∏è Automatizaci√≥n del backend remoto

Este workshop incluye dos scripts para facilitar la creaci√≥n y eliminaci√≥n del bucket remoto que almacena el estado de Terraform (`terraform.tfstate`):

- [`create-backend.sh`](./scripts/create-backend.sh): crea el bucket con versionado habilitado
- [`delete-backend.sh`](./scripts/delete-backend.sh): elimina el bucket con confirmaci√≥n y soporte para versionado

Consulta [`steps.md`](./steps.md) para ver el flujo completo validado desde cero.

---

## üìù Conclusi√≥n

Este workshop demuestra un flujo completo de DevOps para infraestructura serverless en AWS, integrando mejores pr√°cticas de seguridad, automatizaci√≥n y gesti√≥n de costos. El enfoque en la destrucci√≥n autom√°tica asegura control de costos y reproduceibilidad.

¬øListo para implementar? üöÄ Configura correctamente las credenciales AWS en GitHub Secrets y sigue los workflows automatizados para un despliegue sin problemas.


